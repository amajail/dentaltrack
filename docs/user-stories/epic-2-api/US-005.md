# US-005: Configurar Clean Architecture backend completa

## ğŸ“‹ User Story
**Como** desarrollador del equipo DentalTrack  
**Quiero** configurar el backend con Clean Architecture completa  
**Para que** tener una API robusta, escalable y mantenible para el MVP

## âœ… Criterios de AceptaciÃ³n

### ğŸ—ï¸ Clean Architecture
- [ ] Domain Layer configurada con entidades y value objects
- [ ] Application Layer configurada con MediatR, DTOs y handlers
- [ ] Infrastructure Layer configurada con EF Core y repositories
- [ ] API Layer configurada con controllers y middleware
- [ ] Dependency Injection configurado correctamente

### ğŸ“¦ Paquetes y ConfiguraciÃ³n
- [ ] Entity Framework Core con SQL Server configurado
- [ ] MediatR para CQRS pattern implementado
- [ ] AutoMapper para mapeo DTO configurado
- [ ] FluentValidation para validaciones implementado
- [ ] Serilog para logging configurado
- [ ] Swagger/OpenAPI para documentaciÃ³n

### ğŸ”§ Estructura Base
- [ ] Program.cs con DI container configurado
- [ ] appsettings.json con configuraciones por ambiente
- [ ] Middleware personalizado para manejo de errores
- [ ] CORS configurado para frontend
- [ ] Health checks implementados

## ğŸ› ï¸ Claude Code Prompt

```
Configurar backend .NET 8 con Clean Architecture para DentalTrack MVP:

CONTEXTO: DentalTrack MVP - Sistema de gestiÃ³n dental con IA
- Web API para frontend React
- SQL Server database
- Azure deployment ready
- Google OAuth integration

CLEAN ARCHITECTURE SETUP:

1. DOMAIN LAYER (DentalTrack.Domain):
   - Entities: Patient, Treatment, Photo, Analysis
   - Value Objects: PatientId, TreatmentType, PhotoMetadata
   - Domain Events: TreatmentStarted, PhotoUploaded, AnalysisCompleted
   - Interfaces: IRepository base, domain services
   - No dependencies externas

2. APPLICATION LAYER (DentalTrack.Application):
   - Commands: CreatePatient, StartTreatment, UploadPhoto
   - Queries: GetPatient, GetTreatments, GetPhotos
   - DTOs: PatientDto, TreatmentDto, PhotoDto
   - Handlers: MediatR command/query handlers
   - Interfaces: application services
   - Dependencies: MediatR, AutoMapper, FluentValidation

3. INFRASTRUCTURE LAYER (DentalTrack.Infrastructure):
   - Data: DbContext, Entity configurations
   - Repositories: Generic repository pattern
   - Services: External APIs (Azure Cognitive Services)
   - Dependencies: EF Core, Azure SDKs

4. API LAYER (DentalTrack.Api):
   - Controllers: RESTful endpoints
   - Middleware: Error handling, logging
   - Configuration: DI, CORS, Swagger
   - Dependencies: Application layer

PACKAGES REQUERIDOS:
- Microsoft.EntityFrameworkCore.SqlServer
- MediatR
- AutoMapper.Extensions.Microsoft.DependencyInjection
- FluentValidation.DependencyInjectionExtensions
- Serilog.AspNetCore
- Swashbuckle.AspNetCore
- Microsoft.AspNetCore.Authentication.JwtBearer

CONFIGURACIÃ“N:
- Connection string para SQL Server
- CORS para frontend React
- JWT authentication ready
- Environment-specific appsettings
- Health checks endpoint
- Swagger UI habilitado

ESTRUCTURA DE CARPETAS:
```
backend/src/
â”œâ”€â”€ DentalTrack.Domain/
â”‚   â”œâ”€â”€ Entities/
â”‚   â”œâ”€â”€ ValueObjects/
â”‚   â”œâ”€â”€ Events/
â”‚   â””â”€â”€ Interfaces/
â”œâ”€â”€ DentalTrack.Application/
â”‚   â”œâ”€â”€ Commands/
â”‚   â”œâ”€â”€ Queries/
â”‚   â”œâ”€â”€ DTOs/
â”‚   â”œâ”€â”€ Handlers/
â”‚   â””â”€â”€ Interfaces/
â”œâ”€â”€ DentalTrack.Infrastructure/
â”‚   â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ Repositories/
â”‚   â””â”€â”€ Services/
â””â”€â”€ DentalTrack.Api/
    â”œâ”€â”€ Controllers/
    â”œâ”€â”€ Middleware/
    â””â”€â”€ Program.cs
```

ENDPOINTS INICIALES:
- GET /health
- GET /api/patients
- POST /api/patients
- GET /api/treatments
- POST /api/treatments

NO INCLUIR:
- Authentication implementation (serÃ¡ US-015)
- Photo upload functionality (serÃ¡ US-021)
- AI analysis (serÃ¡ US-024)
```

## ğŸ“ Notas TÃ©cnicas
- **Epic**: Web API
- **Dependencias**: US-001 (monorepo), US-004 (Azure)
- **EstimaciÃ³n**: XL (8 puntos)
- **Platform**: Backend
- **Sprint**: Sprint 1

## ğŸ§ª Definition of Done
- [ ] Clean Architecture implementada con 4 capas
- [ ] Todos los paquetes NuGet configurados
- [ ] Dependency Injection funcionando correctamente
- [ ] Entity Framework configurado y migraciones
- [ ] Swagger UI documentando endpoints
- [ ] Health checks respondiendo
- [ ] CORS configurado para frontend
- [ ] Logging con Serilog funcionando
- [ ] Tests unitarios para handlers >80% coverage
- [ ] Deploy en staging exitoso

## ğŸ”— Links Relacionados
- **Epic**: [Web API](../README.md#epic-2-web-api)
- **Anterior**: [US-004: Azure Infrastructure](../epic-1-setup/US-004.md)
- **Siguiente**: [US-006: Entity Framework](./US-006.md)

## ğŸ“‹ Tasks TÃ©cnicos
- [ ] Configurar Domain Layer con entidades base
- [ ] Configurar Application Layer con MediatR
- [ ] Configurar Infrastructure Layer con EF Core
- [ ] Configurar API Layer con controllers
- [ ] Instalar y configurar todos los paquetes NuGet
- [ ] Configurar Dependency Injection en Program.cs
- [ ] Configurar appsettings por ambiente
- [ ] Implementar health checks
- [ ] Configurar Swagger/OpenAPI
- [ ] Configurar CORS y middleware
- [ ] Crear migraciones iniciales
- [ ] Escribir tests unitarios

---

ğŸ“… **Creado**: 2025-07-20  
ğŸ¯ **Sprint**: Sprint 1  
ğŸ‘¤ **Asignado**: Backend Team  
ğŸ”„ **Estado**: âœ… **COMPLETED**  
ğŸ“… **Completado**: 2025-01-27  

## âœ… Implementation Summary

### ğŸ—ï¸ Clean Architecture Implemented
- âœ… **Domain Layer**: Complete with entities, value objects, and interfaces
- âœ… **Application Layer**: MediatR CQRS pattern with commands, queries, and handlers
- âœ… **Infrastructure Layer**: EF Core with repository pattern and Unit of Work
- âœ… **API Layer**: RESTful controllers with proper dependency injection

### ğŸ“¦ Technologies Configured
- âœ… **Entity Framework Core** with SQL Server
- âœ… **MediatR** for CQRS pattern
- âœ… **AutoMapper** for DTO mapping
- âœ… **Serilog** for structured logging
- âœ… **Swagger/OpenAPI** for API documentation
- âœ… **Health Checks** for monitoring

### ğŸ¯ Key Features Delivered
- âœ… RESTful API endpoints for Patients and Treatments
- âœ… Custom error handling middleware
- âœ… CORS configuration for frontend integration
- âœ… Environment-specific configuration
- âœ… Comprehensive dependency injection setup