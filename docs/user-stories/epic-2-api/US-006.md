# US-006: Configurar Entity Framework y base de datos

## ğŸ“‹ User Story
**Como** desarrollador del equipo DentalTrack  
**Quiero** configurar Entity Framework con modelos de base de datos  
**Para que** tener persistencia de datos robusta y escalable

## âœ… Criterios de AceptaciÃ³n

### ğŸ—ƒï¸ Database Schema
- [ ] Tabla Patients con campos completos
- [ ] Tabla Treatments con relaciÃ³n a Patients
- [ ] Tabla Photos con relaciÃ³n a Treatments
- [ ] Tabla Users para autenticaciÃ³n
- [ ] Ãndices optimizados para consultas frecuentes
- [ ] Constraints y foreign keys configuradas

### ğŸ”§ Entity Framework
- [ ] DbContext configurado con todas las entidades
- [ ] Entity configurations con Fluent API
- [ ] Repository pattern implementado
- [ ] Unit of Work pattern implementado
- [ ] Connection string por ambiente
- [ ] Migraciones configuradas y aplicadas

### ğŸ“Š Seed Data
- [ ] Datos de prueba para desarrollo
- [ ] Usuarios de prueba configurados
- [ ] Tratamientos de ejemplo
- [ ] ConfiguraciÃ³n de ambiente de desarrollo

## ğŸ› ï¸ Claude Code Prompt

```
Configurar Entity Framework y base de datos para DentalTrack MVP:

CONTEXTO: Sistema de gestiÃ³n dental con pacientes, tratamientos y fotos
- SQL Server database
- Entity Framework Core
- Clean Architecture pattern
- Ambiente development y production

DATABASE SCHEMA:

1. PATIENTS TABLE:
   - PatientId (PK, GUID)
   - FirstName (varchar 100)
   - LastName (varchar 100)
   - Email (varchar 255, unique)
   - Phone (varchar 20)
   - DateOfBirth (datetime2)
   - Gender (varchar 10)
   - MedicalHistory (nvarchar max)
   - CreatedAt (datetime2)
   - UpdatedAt (datetime2)
   - IsActive (bit)

2. TREATMENTS TABLE:
   - TreatmentId (PK, GUID)
   - PatientId (FK)
   - TreatmentType (varchar 50) // Blanqueamiento, etc.
   - StartDate (datetime2)
   - EndDate (datetime2, nullable)
   - Status (varchar 20) // Active, Completed, Cancelled
   - Notes (nvarchar max)
   - CreatedAt (datetime2)
   - UpdatedAt (datetime2)

3. PHOTOS TABLE:
   - PhotoId (PK, GUID)
   - TreatmentId (FK)
   - FileName (varchar 255)
   - FilePath (varchar 500)
   - PhotoType (varchar 20) // Before, During, After
   - CaptureDate (datetime2)
   - FileSize (bigint)
   - MimeType (varchar 100)
   - CreatedAt (datetime2)

4. USERS TABLE:
   - UserId (PK, GUID)
   - Email (varchar 255, unique)
   - GoogleId (varchar 100, unique)
   - FirstName (varchar 100)
   - LastName (varchar 100)
   - Role (varchar 20) // Doctor, Assistant, Admin
   - IsActive (bit)
   - CreatedAt (datetime2)
   - LastLoginAt (datetime2, nullable)

ENTITY FRAMEWORK CONFIGURATION:

1. DbContext Setup:
   - DentalTrackDbContext class
   - Connection string configuration
   - Model configurations
   - Override SaveChanges para auditorÃ­a

2. Entity Configurations:
   - Fluent API para cada entidad
   - Relaciones y constraints
   - Ãndices para performance
   - Value conversions donde aplique

3. Repository Pattern:
   - IGenericRepository<T> interface
   - GenericRepository<T> implementation
   - Specific repositories: IPatientRepository, ITreatmentRepository
   - Unit of Work pattern para transacciones

4. Migrations:
   - Initial migration con schema completo
   - Seed data migration
   - Scripts para deployment

CONNECTION STRINGS:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=DentalTrackDb;Trusted_Connection=true;MultipleActiveResultSets=true",
    "AzureConnection": "Server=tcp:{server}.database.windows.net,1433;Initial Catalog=DentalTrackDb;Persist Security Info=False;User ID={user};Password={password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
  }
}
```

SEED DATA:
- 3 pacientes de prueba
- 2 tratamientos activos
- 1 usuario doctor de prueba
- Datos realistas para testing

ÃNDICES REQUERIDOS:
- Patient.Email (unique)
- Patient.LastName
- Treatment.PatientId
- Treatment.Status + StartDate
- Photo.TreatmentId + PhotoType
- User.Email (unique)
- User.GoogleId (unique)

CONFIGURACIÃ“N DI:
```csharp
services.AddDbContext<DentalTrackDbContext>(options =>
    options.UseSqlServer(connectionString));
services.AddScoped<IUnitOfWork, UnitOfWork>();
services.AddScoped(typeof(IGenericRepository<>), typeof(GenericRepository<>));
```

NO INCLUIR:
- AuditorÃ­a avanzada (logging automÃ¡tico)
- Soft delete global
- Multi-tenancy
- Performance monitoring avanzado
```

## ğŸ“ Notas TÃ©cnicas
- **Epic**: Web API
- **Dependencias**: US-005 (Clean Architecture)
- **EstimaciÃ³n**: L (5 puntos)
- **Platform**: Backend
- **Sprint**: Sprint 1

## ğŸ§ª Definition of Done
- [ ] Todas las entidades configuradas en EF
- [ ] Migraciones aplicadas exitosamente
- [ ] Repository pattern implementado
- [ ] Unit of Work funcionando
- [ ] Seed data aplicado en development
- [ ] Connection strings configurados por ambiente
- [ ] Ãndices optimizados aplicados
- [ ] Tests de integraciÃ³n para repositorios
- [ ] Database creado en Azure SQL
- [ ] Performance de consultas validado

## ğŸ”— Links Relacionados
- **Epic**: [Web API](../README.md#epic-2-web-api)
- **Anterior**: [US-005: Clean Architecture](./US-005.md)
- **Siguiente**: [US-007: Endpoints bÃ¡sicos](./US-007.md)

## ğŸ“‹ Tasks TÃ©cnicos
- [ ] Crear entidades de dominio (Patient, Treatment, Photo, User)
- [ ] Configurar DbContext con entity configurations
- [ ] Implementar repository pattern genÃ©rico
- [ ] Implementar Unit of Work pattern
- [ ] Crear migraciÃ³n inicial con schema completo
- [ ] Configurar connection strings por ambiente
- [ ] Crear seed data para desarrollo
- [ ] Aplicar Ã­ndices de performance
- [ ] Configurar DI para repositories
- [ ] Escribir tests de integraciÃ³n
- [ ] Validar performance de consultas

---

ğŸ“… **Creado**: 2025-07-20  
ğŸ¯ **Sprint**: Sprint 1  
ğŸ‘¤ **Asignado**: Backend Team  
ğŸ”„ **Estado**: âœ… **COMPLETED**  
ğŸ“… **Completado**: 2025-01-27  

## âœ… Implementation Summary

### ğŸ—ƒï¸ Database Schema Implemented
- âœ… **Patients Table**: Complete with all required fields and constraints
- âœ… **Treatments Table**: With foreign key relationship to Patients
- âœ… **Photos Table**: Linked to treatments with metadata
- âœ… **Users Table**: For authentication and authorization
- âœ… **Analyses Table**: For AI analysis results

### ğŸ”§ Entity Framework Features
- âœ… **DbContext**: Fully configured with all entities
- âœ… **Fluent API**: Entity configurations with proper relationships
- âœ… **Repository Pattern**: Generic and specific repository implementations
- âœ… **Unit of Work**: Transaction management pattern
- âœ… **Migrations**: Initial schema and performance indexes
- âœ… **Seed Data**: Development data seeding implemented

### ğŸ“Š Performance Optimizations
- âœ… **Indexes**: Optimized indexes for frequent queries
- âœ… **Foreign Keys**: Proper relationship constraints
- âœ… **Query Performance**: Efficient entity configurations
- âœ… **Connection Management**: Environment-specific connection strings